<!DOCTYPE html>
<html>
<head>
    <title>Piano</title>
    <script type="text/javascript">
        var midiTable = {
          "z": 60,
          "s": 61,
          "x": 62,
          "d": 63,
          "c": 64,
          "v": 65,
          "g": 66,
          "b": 67,
          "h": 68,
          "n": 69,
          "j": 70,
          "m": 71,
          ",": 72,
          "Z": 72,
          "S": 73,
          "X": 74,
          "D": 75,
          "C": 76,
          "V": 77,
          "G": 78,
          "B": 79,
          "H": 80,
          "N": 81,
          "J": 82,
          "M": 83,
          "<": 84
        };
        // https://elgervanboxtel.nl/site/blog/xmlhttprequest-extended-with-promises
        var Request = (function() {
            var get = function(url) {
                return request('GET', url);
            },
            post = function(url){
                return request('POST', url);
            },
            request = function(method, url) {
                return new Promise(function (resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open(method, url);
                    xhr.onload = function(e){
                        if (xhr.status === 200) {
                            resolve(xhr);
                        } else {
                            reject(Error('XMLHttpRequest failed; error code:' + xhr.statusText));
                        }
                    },
                    xhr.onerror = reject;
                    xhr.send();
                });
            };

            return {
                get: get,
                post: post,
                request: request
            }
        })();
        var handleNote = function (command, note, velocity) {
            if (note) {
                Request.get("midi?command=" + command + "&note=" + note + "&velocity=" + velocity).catch(function(e) { // catch all XHR errors
                    console.error('Network error while fetching');
                }).then(function (e) {
                    return e.response;
                }).then(function (responseXML) {
                    console.log(responseXML);
                }).catch(function(e) { // catch all other errors
                    console.dir(e);
                    console.log(e.message, "readystate:", e);
                    // throw an error
                    throw new Error("throw error");
                });
            }
        }
        window.addEventListener("keydown", function (e) {
            if (!e.repeat) {
                handleNote("note_on", midiTable[e.key], 127);
            }
        }, false);
        window.addEventListener("keyup", function (e) {
            if (!e.repeat) {
                handleNote("note_off", midiTable[e.key], 127);
            }
        }, false);
    </script>
</head>
<body>
    <h1>Piano</h1>
</body>
</html>

